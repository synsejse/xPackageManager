import { Button, VerticalBox, HorizontalBox, ListView, ScrollView, LineEdit, ProgressIndicator, Spinner, Palette } from "std-widgets.slint";

export struct PackageData {
    name: string,
    display-name: string,
    version: string,
    description: string,
    repository: string,
    backend: int,
    installed: bool,
    has-update: bool,
    installed-size: string,
    licenses: string,
    url: string,
    dependencies: string,
    required-by: string,
    icon-name: string,
    selected: bool,
}

export struct StatsData {
    pacman-count: int,
    flatpak-count: int,
    orphan-count: int,
    update-count: int,
    cache-size: string,
}

// Nav button - clean professional style
component NavButton inherits Rectangle {
    in property <string> icon;
    in property <string> label;
    in property <bool> active: false;
    callback clicked;

    height: 38px;
    border-radius: 8px;
    background: active ? #9b59b6 : (touch.has-hover ? Palette.control-background : transparent);

    touch := TouchArea {
        mouse-cursor: pointer;
        clicked => { root.clicked(); }
    }

    HorizontalLayout {
        padding-left: 12px;
        padding-right: 12px;
        spacing: 12px;

        Text {
            width: 22px;
            text: icon;
            font-size: 16px;
            color: active ? white : Palette.foreground;
            horizontal-alignment: center;
            vertical-alignment: center;
        }

        Text {
            text: label;
            font-size: 14px;
            font-weight: active ? 500 : 400;
            color: active ? white : Palette.foreground;
            vertical-alignment: center;
            horizontal-stretch: 1;
        }
    }
}

// Custom checkbox
component CheckBox inherits Rectangle {
    in property <bool> checked: false;
    callback toggled(bool);

    width: 20px;
    height: 20px;
    border-radius: 4px;
    border-width: checked ? 0 : 1.5px;
    border-color: Palette.foreground.with-alpha(0.3);
    background: checked ? #9b59b6 : transparent;

    animate background { duration: 120ms; }

    Text {
        text: "âœ“";
        font-size: 13px;
        font-weight: 700;
        color: white;
        horizontal-alignment: center;
        vertical-alignment: center;
        visible: checked;
    }

    TouchArea {
        mouse-cursor: pointer;
        clicked => { root.toggled(!root.checked); }
    }
}

// Package row
component PackageRow inherits Rectangle {
    in property <PackageData> pkg;
    in property <bool> show-separator: true;
    in property <bool> show-checkbox: false;
    callback clicked;
    callback install;
    callback remove;
    callback toggle-selected(bool);

    height: 52px;
    background: pkg.selected ? #9b59b6.with-alpha(0.08) : (touch.has-hover ? Palette.alternate-background : transparent);

    touch := TouchArea {
        mouse-cursor: pointer;
        clicked => { root.clicked(); }
    }

    HorizontalLayout {
        padding-left: 14px;
        padding-right: 14px;
        spacing: 10px;

        // Checkbox
        if show-checkbox: VerticalLayout {
            alignment: center;
            CheckBox {
                checked: pkg.selected;
                toggled(val) => { root.toggle-selected(val); }
            }
        }

        // Info
        VerticalLayout {
            horizontal-stretch: 1;
            spacing: 2px;
            alignment: center;

            Text {
                text: pkg.display-name;
                font-size: 14px;
                font-weight: 500;
                color: pkg.has-update ? #9b59b6 : Palette.foreground;
                overflow: elide;
            }

            Text {
                text: pkg.description;
                font-size: 12px;
                color: Palette.foreground;
                opacity: 0.5;
                overflow: elide;
            }
        }

        // Inline action button
        VerticalLayout {
            alignment: center;
            Rectangle {
            width: 72px;
            height: 28px;
            border-radius: 6px;
            background: pkg.has-update ? #9b59b6 : (pkg.installed ? #e74c3c : #9b59b6);

            Text {
                text: pkg.has-update ? "Update" : (pkg.installed ? "Remove" : "Install");
                font-size: 11px;
                font-weight: 600;
                color: white;
                horizontal-alignment: center;
                vertical-alignment: center;
            }

            TouchArea {
                mouse-cursor: pointer;
                clicked => {
                    if pkg.has-update { root.install(); }
                    else if pkg.installed { root.remove(); }
                    else { root.install(); }
                }
            }
            }
        }
    }

    // Bottom separator
    Rectangle {
        x: 14px;
        y: parent.height - 1px;
        width: parent.width - 28px;
        height: show-separator ? 1px : 0;
        background: Palette.border;
    }
}

// Distro warning window â€” shown when not running on XeroLinux
export component DistroWarning inherits Window {
    title: "xPackage Manager";
    preferred-width: 440px;
    preferred-height: 280px;
    min-width: 440px;
    min-height: 280px;
    background: Palette.background;

    callback dismiss;

    VerticalLayout {
        padding: 0;

        // Header
        Rectangle {
            height: 56px;
            background: #e74c3c.with-alpha(0.12);

            HorizontalLayout {
                padding-left: 20px;
                padding-right: 20px;
                spacing: 10px;
                alignment: center;

                Text {
                    text: "âš ï¸";
                    font-size: 22px;
                    vertical-alignment: center;
                }
                Text {
                    text: "Unsupported Distribution";
                    font-size: 17px;
                    font-weight: 700;
                    color: #e74c3c;
                    vertical-alignment: center;
                }
            }
        }

        // Separator
        Rectangle { height: 1px; background: Palette.border; }

        // Body
        Rectangle {
            vertical-stretch: 1;

            VerticalLayout {
                padding: 24px;
                padding-top: 20px;
                spacing: 8px;
                alignment: center;

                Text {
                    text: "ðŸš«  Invalid distro detected";
                    font-size: 14px;
                    font-weight: 600;
                    color: Palette.foreground;
                    horizontal-alignment: center;
                }
                Text {
                    text: "Please make sure you are running this\non XeroLinux before using this tool.";
                    font-size: 13px;
                    color: Palette.foreground;
                    opacity: 0.7;
                    horizontal-alignment: center;
                }
            }
        }

        // Separator
        Rectangle { height: 1px; background: Palette.border; }

        // Button area
        Rectangle {
            height: 56px;

            HorizontalLayout {
                alignment: center;
                padding: 12px;

                Rectangle {
                    width: 180px;
                    height: 34px;
                    border-radius: 8px;
                    background: dismiss-touch.has-hover ? #c0392b : #e74c3c;
                    animate background { duration: 120ms; }

                    Text {
                        text: "Understood...";
                        font-size: 13px;
                        font-weight: 600;
                        color: white;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }

                    dismiss-touch := TouchArea {
                        mouse-cursor: pointer;
                        clicked => { root.dismiss(); }
                    }
                }
            }
        }
    }
}

// Main window
export component MainWindow inherits Window {
    title: "xPackage Manager";
    preferred-width: 1100px;
    preferred-height: 720px;
    min-width: 850px;
    min-height: 550px;
    background: Palette.background;

    in-out property <int> view: 0;
    in-out property <[PackageData]> installed-packages: [];
    in-out property <[PackageData]> update-packages: [];
    in-out property <[PackageData]> search-packages: [];
    in-out property <[PackageData]> flatpak-packages: [];
    in-out property <[PackageData]> firmware-packages: [];
    in-out property <int> selected-index: -1;
    in-out property <bool> loading: false;
    in-out property <bool> busy: false;
    in-out property <string> status-message: "Ready";
    in-out property <int> progress: 0;
    in-out property <StatsData> stats;
    in-out property <string> search-text: "";
    in-out property <PackageData> local-package;
    in-out property <string> local-package-path: "";
    in-out property <bool> show-local-install: false;
    in-out property <[PackageData]> category-packages: [];
    in-out property <bool> show-category-grid: true;
    in-out property <string> current-category-name: "";
    in-out property <[PackageData]> repo-packages: [];
    in-out property <[string]> repos: [];
    in-out property <string> current-repo-name: "";
    in-out property <string> progress-text: "";
    in-out property <bool> show-terminal: false;
    in-out property <string> terminal-title: "";
    in-out property <string> terminal-output: "";
    in-out property <bool> terminal-done: false;
    in-out property <bool> terminal-success: false;
    in-out property <bool> show-troubleshoot-menu: false;

    // Multi-select
    in-out property <int> selected-count: 0;
    in-out property <int> selected-installed-count: 0;
    in-out property <int> selected-uninstalled-count: 0;
    in-out property <bool> multi-select-mode: true;

    // Confirmation popup
    in-out property <bool> show-confirm-popup: false;
    in-out property <string> confirm-title: "";
    in-out property <string> confirm-action: "";
    in-out property <string> confirm-package-names: "";
    in-out property <string> confirm-version: "";
    in-out property <string> confirm-size: "";
    in-out property <string> confirm-deps: "";
    in-out property <int> confirm-backend: 0;
    in-out property <int> confirm-package-count: 1;

    // Progress popup
    in-out property <bool> show-progress-popup: false;
    in-out property <string> progress-popup-title: "";
    in-out property <int> progress-popup-percent: 0;
    in-out property <string> progress-popup-stage: "";
    in-out property <bool> progress-popup-done: false;
    in-out property <bool> progress-popup-success: false;
    in-out property <string> progress-popup-output: "";
    in-out property <bool> progress-popup-show-input: false;
    in-out property <string> progress-popup-prompt: "";

    callback refresh;
    callback search(string);
    callback install-package(string, int);
    callback remove-package(string, int);
    callback update-package(string, int);
    callback update-all;
    callback sync-databases;
    callback open-url(string);
    callback install-local-package(string);
    callback cancel-local-install;
    callback load-category(string);
    callback load-repo(string);
    callback terminal-send-input(string);
    callback terminal-close;
    callback update-mirrorlists;
    callback fix-keyring;

    // Multi-select callbacks
    callback toggle-package-selected(string, int, bool);
    callback bulk-install;
    callback bulk-remove;
    callback clear-selection;

    // Confirmation callbacks
    callback request-install(string, int);
    callback request-remove(string, int);
    callback request-update(string, int);
    callback confirm-operation;
    callback cancel-confirm;

    // Progress popup callbacks
    callback close-progress-popup;
    callback progress-popup-send-input(string);

    function get-list() -> [PackageData] {
        if view == 0 { return installed-packages; }
        if view == 1 { return update-packages; }
        if view == 2 { return search-packages; }
        if view == 3 { return flatpak-packages; }
        if view == 6 { return firmware-packages; }
        if view == 7 { return category-packages; }
        if view == 8 { return repo-packages; }
        return [];
    }

    // Use absolute positioning to prevent layout recalculation
    // Sidebar - fixed left
    Rectangle {
        x: 0;
        y: 0;
        width: 210px;
        height: parent.height;
        background: Palette.alternate-background.with-alpha(0.85);

            VerticalLayout {
                padding: 12px;
                spacing: 8px;

                // Search
                Rectangle {
                    height: 38px;
                    background: Palette.control-background;
                    border-radius: 8px;

                    HorizontalLayout {
                        padding-left: 12px;
                        padding-right: 12px;
                        spacing: 8px;

                        Text {
                            text: "âŒ•";
                            font-size: 16px;
                            color: Palette.foreground;
                            opacity: 0.5;
                            vertical-alignment: center;
                        }

                        LineEdit {
                            text <=> search-text;
                            placeholder-text: "Search...";
                            horizontal-stretch: 1;
                            accepted => {
                                if search-text != "" {
                                    view = 2;
                                    root.search(search-text);
                                }
                            }
                        }
                    }
                }

                Rectangle { height: 8px; }

                // Nav
                NavButton {
                    icon: "â¬‡";
                    label: "Installed";
                    active: view == 0;
                    clicked => { view = 0; selected-index = -1; }
                }

                NavButton {
                    icon: "ðŸ”";
                    label: "Search";
                    active: view == 2;
                    clicked => { view = 2; selected-index = -1; }
                }

                NavButton {
                    icon: "ðŸ“‚";
                    label: "Browse";
                    active: view == 7;
                    clicked => { view = 7; selected-index = -1; show-category-grid = true; }
                }

                Rectangle { height: 8px; }
                Rectangle { height: 1px; background: Palette.border; }
                Rectangle { height: 8px; }

                NavButton {
                    icon: "ðŸ“¦";
                    label: "Flatpak";
                    active: view == 3;
                    clicked => { view = 3; selected-index = -1; }
                }

                NavButton {
                    icon: "ðŸ”§";
                    label: "Firmware";
                    active: view == 6;
                    clicked => { view = 6; }
                }

                Rectangle { height: 8px; }
                Rectangle { height: 1px; background: Palette.border; }
                Rectangle { height: 8px; }

                // Repos from pacman.conf
                for repo[i] in repos: NavButton {
                    icon: "ðŸ“";
                    label: repo;
                    active: view == 8 && current-repo-name == repo;
                    clicked => {
                        view = 8;
                        current-repo-name = repo;
                        root.load-repo(repo);
                    }
                }

                Rectangle { vertical-stretch: 1; }

                // Actions
                Button {
                    text: "Check for Updates";
                    enabled: !busy;
                    clicked => { root.sync-databases(); }
                }

                if stats.update-count > 0: Button {
                    text: "Available Updates (" + stats.update-count + ")";
                    primary: true;
                    enabled: !busy;
                    clicked => { view = 1; selected-index = -1; }
                }

                Rectangle { height: 6px; }

                Text {
                    text: "Cache: " + stats.cache-size + "  â€¢  " + stats.orphan-count + " orphans";
                    font-size: 11px;
                    color: Palette.foreground;
                    opacity: 0.4;
                    horizontal-alignment: center;
                }
            }
        }

    // Border after sidebar
    Rectangle {
        x: 210px;
        y: 0;
        width: 1px;
        height: parent.height;
        background: Palette.border;
    }

    // Content/List area - positioned absolutely
    Rectangle {
        x: 211px;
        y: 0;
        width: parent.width - 211px;
        height: parent.height;

            VerticalLayout {
                padding: 20px;
                padding-top: 24px;
                spacing: 16px;

                // Header
                HorizontalLayout {
                    spacing: 12px;

                    Text {
                        text: view == 0 ? "Installed Packages" :
                              view == 1 ? "Available Updates" :
                              view == 2 ? "Search Results" :
                              view == 3 ? "Flatpak Applications" :
                              view == 6 ? "Firmware Updates" :
                              view == 7 && show-category-grid ? "Browse by Category" :
                              view == 7 ? current-category-name :
                              view == 8 ? current-repo-name : "Packages";
                        font-size: 20px;
                        font-weight: 600;
                        color: Palette.foreground;
                    }

                    Rectangle { horizontal-stretch: 1; }

                    if !(view == 7 && show-category-grid): Text {
                        text: get-list().length + " packages";
                        font-size: 13px;
                        color: Palette.foreground;
                        opacity: 0.5;
                        vertical-alignment: center;
                    }

                    if view == 1 && update-packages.length > 0: Button {
                        text: "Update All";
                        primary: true;
                        enabled: !busy;
                        clicked => { root.update-all(); }
                    }


                    // Troubleshoot button
                    Rectangle {
                        width: 120px;
                        height: 32px;
                        border-radius: 6px;
                        background: troubleshoot-touch.has-hover ? Palette.control-background : transparent;

                        HorizontalLayout {
                            padding-left: 10px;
                            padding-right: 10px;
                            spacing: 6px;
                            alignment: center;

                            Text {
                                text: "ðŸ”§";
                                font-size: 13px;
                                vertical-alignment: center;
                            }

                            Text {
                                text: "Troubleshoot";
                                font-size: 13px;
                                color: Palette.foreground;
                                vertical-alignment: center;
                            }
                        }

                        troubleshoot-touch := TouchArea {
                            mouse-cursor: pointer;
                            clicked => { show-troubleshoot-menu = !show-troubleshoot-menu; }
                        }
                    }
                }

                Rectangle { height: 1px; background: Palette.border; }

                // Database sync notice
                Rectangle {
                    height: 32px;
                    border-radius: 6px;
                    background: #e67e22.with-alpha(0.15);
                    HorizontalLayout {
                        padding-left: 12px;
                        padding-right: 12px;
                        spacing: 8px;
                        alignment: center;
                        Text { text: "âš "; font-size: 13px; vertical-alignment: center; }
                        Text {
                            text: "Click \"Check for Updates\" in the sidebar to sync databases & check for any available updates";
                            font-size: 11.5px;
                            color: Palette.foreground;
                            opacity: 0.8;
                            vertical-alignment: center;
                        }
                    }
                }

                if loading: VerticalLayout {
                    vertical-stretch: 1;
                    alignment: center;
                    HorizontalLayout {
                        alignment: center;
                        Spinner { indeterminate: true; }
                    }
                }

                if !loading && view != 7 && get-list().length == 0: VerticalLayout {
                    vertical-stretch: 1;
                    alignment: center;
                    Text {
                        text: view == 2 ? "Type to search" : "No packages";
                        font-size: 14px;
                        color: Palette.foreground;
                        opacity: 0.4;
                        horizontal-alignment: center;
                    }
                }

                if !loading && view == 0 && installed-packages.length > 0: ListView {
                    vertical-stretch: 1;
                    for p[i] in installed-packages: PackageRow {
                        pkg: p;
                        show-separator: i < installed-packages.length - 1;
                        show-checkbox: multi-select-mode;
                        install => { root.request-install(p.name, p.backend); }
                        remove => { root.request-remove(p.name, p.backend); }
                        toggle-selected(val) => { root.toggle-package-selected(p.name, p.backend, val); }
                    }
                }

                if !loading && view == 1 && update-packages.length > 0: ListView {
                    vertical-stretch: 1;
                    for p[i] in update-packages: PackageRow {
                        pkg: p;
                        show-separator: i < update-packages.length - 1;
                        show-checkbox: multi-select-mode;
                        install => { root.request-update(p.name, p.backend); }
                        remove => { root.request-remove(p.name, p.backend); }
                        toggle-selected(val) => { root.toggle-package-selected(p.name, p.backend, val); }
                    }
                }

                if !loading && view == 2 && search-packages.length > 0: ListView {
                    vertical-stretch: 1;
                    for p[i] in search-packages: PackageRow {
                        pkg: p;
                        show-separator: i < search-packages.length - 1;
                        show-checkbox: multi-select-mode;
                        install => { root.request-install(p.name, p.backend); }
                        remove => { root.request-remove(p.name, p.backend); }
                        toggle-selected(val) => { root.toggle-package-selected(p.name, p.backend, val); }
                    }
                }

                if !loading && view == 3 && flatpak-packages.length > 0: ListView {
                    vertical-stretch: 1;
                    for p[i] in flatpak-packages: PackageRow {
                        pkg: p;
                        show-separator: i < flatpak-packages.length - 1;
                        show-checkbox: multi-select-mode;
                        install => { root.request-install(p.name, p.backend); }
                        remove => { root.request-remove(p.name, p.backend); }
                        toggle-selected(val) => { root.toggle-package-selected(p.name, p.backend, val); }
                    }
                }

                if !loading && view == 6 && firmware-packages.length > 0: ListView {
                    vertical-stretch: 1;
                    for p[i] in firmware-packages: PackageRow {
                        pkg: p;
                        show-separator: i < firmware-packages.length - 1;
                        show-checkbox: multi-select-mode;
                        install => { root.request-install(p.name, p.backend); }
                        remove => { root.request-remove(p.name, p.backend); }
                        toggle-selected(val) => { root.toggle-package-selected(p.name, p.backend, val); }
                    }
                }

                // Repo package list
                if !loading && view == 8 && repo-packages.length > 0: ListView {
                    vertical-stretch: 1;
                    for p[i] in repo-packages: PackageRow {
                        pkg: p;
                        show-separator: i < repo-packages.length - 1;
                        show-checkbox: multi-select-mode;
                        install => { root.request-install(p.name, p.backend); }
                        remove => { root.request-remove(p.name, p.backend); }
                        toggle-selected(val) => { root.toggle-package-selected(p.name, p.backend, val); }
                    }
                }

                if !loading && view == 8 && repo-packages.length == 0: VerticalLayout {
                    vertical-stretch: 1;
                    alignment: center;
                    Text {
                        text: "No packages in " + current-repo-name;
                        font-size: 14px;
                        color: Palette.foreground;
                        opacity: 0.4;
                        horizontal-alignment: center;
                    }
                }

                // Browse by Category - Grid View
                if !loading && view == 7 && show-category-grid: Rectangle {
                    vertical-stretch: 1;

                    // Large background text in multiple languages
                    Text { x: -20px; y: 15px; text: "APPS"; font-size: 72px; font-weight: 900; color: Palette.foreground; opacity: 0.08; }
                    Text { x: parent.width - 220px; y: 5px; text: "è½¯ä»¶"; font-size: 64px; font-weight: 900; color: Palette.foreground; opacity: 0.08; }
                    Text { x: 30px; y: parent.height - 90px; text: "ã‚¢ãƒ—ãƒª"; font-size: 56px; font-weight: 900; color: Palette.foreground; opacity: 0.08; }
                    Text { x: parent.width - 280px; y: parent.height - 85px; text: "LOGICIEL"; font-size: 48px; font-weight: 900; color: Palette.foreground; opacity: 0.07; }

                    // Medium decorative text
                    Text { x: 10px; y: 95px; text: "Install"; font-size: 28px; font-weight: 700; color: Palette.foreground; opacity: 0.12; }
                    Text { x: parent.width - 110px; y: 85px; text: "Discover"; font-size: 24px; font-weight: 700; color: Palette.foreground; opacity: 0.12; }
                    Text { x: 15px; y: parent.height / 2 + 60px; text: "Launch"; font-size: 26px; font-weight: 700; color: Palette.foreground; opacity: 0.12; }
                    Text { x: parent.width - 100px; y: parent.height / 2 + 55px; text: "Create"; font-size: 24px; font-weight: 700; color: Palette.foreground; opacity: 0.12; }

                    // Emojis scattered
                    Text { x: 5px; y: 140px; text: "ðŸ“¦"; font-size: 32px; opacity: 0.25; }
                    Text { x: parent.width - 50px; y: 130px; text: "ðŸš€"; font-size: 32px; opacity: 0.25; }
                    Text { x: 10px; y: parent.height - 130px; text: "ðŸŽ®"; font-size: 32px; opacity: 0.25; }
                    Text { x: parent.width - 55px; y: parent.height - 125px; text: "ðŸ”§"; font-size: 32px; opacity: 0.25; }
                    Text { x: parent.width / 2 - 80px; y: 20px; text: "âœ¨"; font-size: 28px; opacity: 0.30; }
                    Text { x: parent.width / 2 + 50px; y: parent.height - 45px; text: "â¬‡"; font-size: 28px; opacity: 0.30; }

                    // Centered grid
                    VerticalLayout {
                        alignment: center;
                        spacing: 10px;

                        HorizontalLayout {
                            alignment: center;
                            spacing: 10px;
                            for cat in [
                                { icon: "ðŸŽµ", label: "Audio & Video", id: "AudioVideo" },
                                { icon: "ðŸ’»", label: "Development", id: "Development" },
                                { icon: "ðŸŽ®", label: "Games", id: "Game" },
                                { icon: "ðŸŽ¨", label: "Graphics", id: "Graphics" },
                                { icon: "ðŸŒ", label: "Internet", id: "Network" },
                            ]: Rectangle {
                                width: 120px;
                                height: 95px;
                                background: Palette.control-background;
                                border-radius: 10px;
                                drop-shadow-blur: tile-touch1.has-hover ? 16px : 8px;
                                drop-shadow-color: tile-touch1.has-hover ? #9b59b6.with-alpha(0.7) : #000000.with-alpha(0.2);
                                drop-shadow-offset-y: tile-touch1.has-hover ? 2px : 4px;
                                animate drop-shadow-blur { duration: 150ms; }
                                animate drop-shadow-color { duration: 150ms; }
                                tile-touch1 := TouchArea {
                                    mouse-cursor: pointer;
                                    clicked => {
                                        show-category-grid = false;
                                        current-category-name = cat.label;
                                        root.load-category(cat.id);
                                    }
                                }
                                VerticalLayout {
                                    alignment: center;
                                    spacing: 6px;
                                    Text { text: cat.icon; font-size: 28px; horizontal-alignment: center; }
                                    Text { text: cat.label; font-size: 12px; font-weight: 500; color: Palette.foreground; horizontal-alignment: center; }
                                }
                            }
                        }

                        HorizontalLayout {
                            alignment: center;
                            spacing: 10px;
                            for cat in [
                                { icon: "ðŸ“„", label: "Office", id: "Office" },
                                { icon: "ðŸŽ“", label: "Education", id: "Education" },
                                { icon: "ðŸ”¬", label: "Science", id: "Science" },
                                { icon: "âš™", label: "System", id: "System" },
                                { icon: "ðŸ”§", label: "Utilities", id: "Utility" },
                            ]: Rectangle {
                                width: 120px;
                                height: 95px;
                                background: Palette.control-background;
                                border-radius: 10px;
                                drop-shadow-blur: tile-touch2.has-hover ? 16px : 8px;
                                drop-shadow-color: tile-touch2.has-hover ? #9b59b6.with-alpha(0.7) : #000000.with-alpha(0.2);
                                drop-shadow-offset-y: tile-touch2.has-hover ? 2px : 4px;
                                animate drop-shadow-blur { duration: 150ms; }
                                animate drop-shadow-color { duration: 150ms; }
                                tile-touch2 := TouchArea {
                                    mouse-cursor: pointer;
                                    clicked => {
                                        show-category-grid = false;
                                        current-category-name = cat.label;
                                        root.load-category(cat.id);
                                    }
                                }
                                VerticalLayout {
                                    alignment: center;
                                    spacing: 6px;
                                    Text { text: cat.icon; font-size: 28px; horizontal-alignment: center; }
                                    Text { text: cat.label; font-size: 12px; font-weight: 500; color: Palette.foreground; horizontal-alignment: center; }
                                }
                            }
                        }
                    }
                }

                // Browse by Category - Package List
                if !loading && view == 7 && !show-category-grid: VerticalLayout {
                    vertical-stretch: 1;

                    HorizontalLayout {
                        padding-bottom: 12px;
                        Rectangle {
                            width: 80px;
                            height: 32px;
                            background: Palette.control-background;
                            border-radius: 6px;
                            Text {
                                text: "â† Back";
                                color: Palette.foreground;
                                vertical-alignment: center;
                                horizontal-alignment: center;
                            }
                            TouchArea {
                                mouse-cursor: pointer;
                                clicked => { show-category-grid = true; selected-index = -1; }
                            }
                        }
                    }

                    if category-packages.length > 0: ListView {
                        vertical-stretch: 1;
                        for p[i] in category-packages: PackageRow {
                            pkg: p;
                            show-separator: i < category-packages.length - 1;
                            show-checkbox: multi-select-mode;
                            install => { root.request-install(p.name, p.backend); }
                            remove => { root.request-remove(p.name, p.backend); }
                            toggle-selected(val) => { root.toggle-package-selected(p.name, p.backend, val); }
                        }
                    }

                    if category-packages.length == 0: Rectangle {
                        vertical-stretch: 1;
                        Text {
                            text: "No apps found in this category";
                            color: Palette.foreground;
                            opacity: 0.5;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }
                    }
                }
            }

        }


    // Enhanced progress bar
    if busy: Rectangle {
        y: parent.height - 28px;
        width: 100%;
        height: 28px;
        background: Palette.alternate-background;

        // Progress track at top
        Rectangle {
            y: 0;
            width: 100%;
            height: 4px;
            background: Palette.border;

            Rectangle {
                width: progress > 0 ? parent.width * (progress / 100) : parent.width * 0.3;
                height: 100%;
                background: #9b59b6;
                animate width { duration: 300ms; easing: ease-in-out; }
            }
        }

        HorizontalLayout {
            padding-left: 12px;
            padding-right: 12px;
            padding-top: 4px;
            spacing: 8px;
            alignment: center;

            if progress == 0: Spinner {
                indeterminate: true;
                width: 16px;
                height: 16px;
            }

            Text {
                text: progress-text != "" ? progress-text : status-message;
                font-size: 11px;
                color: Palette.foreground;
                opacity: 0.7;
                vertical-alignment: center;
                overflow: elide;
                horizontal-stretch: 1;
            }

            if progress > 0: Text {
                text: progress + "%";
                font-size: 11px;
                font-weight: 600;
                color: #9b59b6;
                vertical-alignment: center;
            }
        }
    }

    // Floating action bar for multi-select
    if selected-count > 0: Rectangle {
        x: (parent.width - 420px) / 2;
        y: parent.height - 64px;
        width: 420px;
        height: 48px;
        border-radius: 24px;
        background: Palette.background;
        drop-shadow-blur: 20px;
        drop-shadow-color: #000000.with-alpha(0.25);
        drop-shadow-offset-y: 4px;

        HorizontalLayout {
            padding-left: 20px;
            padding-right: 12px;
            spacing: 12px;

            Text {
                text: selected-count + " selected";
                font-size: 14px;
                font-weight: 500;
                color: Palette.foreground;
                vertical-alignment: center;
            }

            Rectangle { horizontal-stretch: 1; }

            // Clear button
            Rectangle {
                width: 60px;
                height: 32px;
                border-radius: 6px;
                background: fab-clear-touch.has-hover ? Palette.control-background : transparent;

                Text {
                    text: "Clear";
                    font-size: 12px;
                    color: Palette.foreground;
                    opacity: 0.7;
                    horizontal-alignment: center;
                    vertical-alignment: center;
                }

                fab-clear-touch := TouchArea {
                    mouse-cursor: pointer;
                    clicked => { root.clear-selection(); }
                }
            }

            // Install button (enabled only when uninstalled packages selected)
            Rectangle {
                width: 72px;
                height: 32px;
                border-radius: 6px;
                background: selected-uninstalled-count > 0 ? #9b59b6 : Palette.control-background;

                Text {
                    text: "Install";
                    font-size: 12px;
                    font-weight: 600;
                    color: selected-uninstalled-count > 0 ? white : Palette.foreground;
                    opacity: selected-uninstalled-count > 0 ? 1.0 : 0.3;
                    horizontal-alignment: center;
                    vertical-alignment: center;
                }

                TouchArea {
                    mouse-cursor: selected-uninstalled-count > 0 ? pointer : default;
                    clicked => {
                        if selected-uninstalled-count > 0 { root.bulk-install(); }
                    }
                }
            }

            // Remove button (enabled only when installed packages selected)
            Rectangle {
                width: 72px;
                height: 32px;
                border-radius: 6px;
                background: selected-installed-count > 0 ? #e74c3c : Palette.control-background;

                Text {
                    text: "Remove";
                    font-size: 12px;
                    font-weight: 600;
                    color: selected-installed-count > 0 ? white : Palette.foreground;
                    opacity: selected-installed-count > 0 ? 1.0 : 0.3;
                    horizontal-alignment: center;
                    vertical-alignment: center;
                }

                TouchArea {
                    mouse-cursor: selected-installed-count > 0 ? pointer : default;
                    clicked => {
                        if selected-installed-count > 0 { root.bulk-remove(); }
                    }
                }
            }
        }
    }

    // Troubleshoot dropdown menu
    if show-troubleshoot-menu: Rectangle {
        width: 100%;
        height: 100%;
        // Dismiss when clicking outside
        TouchArea {
            clicked => { show-troubleshoot-menu = false; }
        }

        Rectangle {
            x: parent.width - 260px;
            y: 58px;
            width: 240px;
            height: 100px;
            background: Palette.background;
            border-radius: 10px;
            drop-shadow-blur: 20px;
            drop-shadow-color: #000000.with-alpha(0.25);
            drop-shadow-offset-y: 4px;

            VerticalLayout {
                padding: 6px;
                spacing: 2px;

                // Update Mirrorlists
                Rectangle {
                    height: 40px;
                    border-radius: 6px;
                    background: mirror-touch.has-hover ? #9b59b6.with-alpha(0.15) : transparent;

                    HorizontalLayout {
                        padding-left: 12px;
                        spacing: 10px;

                        Text {
                            text: "ðŸŒ";
                            font-size: 15px;
                            vertical-alignment: center;
                        }

                        VerticalLayout {
                            alignment: center;
                            spacing: 1px;
                            Text {
                                text: "Update Mirrorlists";
                                font-size: 13px;
                                font-weight: 500;
                                color: Palette.foreground;
                            }
                            Text {
                                text: "Re-rank fastest mirrors";
                                font-size: 11px;
                                color: Palette.foreground;
                                opacity: 0.5;
                            }
                        }
                    }

                    mirror-touch := TouchArea {
                        mouse-cursor: pointer;
                        clicked => {
                            show-troubleshoot-menu = false;
                            root.update-mirrorlists();
                        }
                    }
                }

                // Fix GnuPG Keyring
                Rectangle {
                    height: 40px;
                    border-radius: 6px;
                    background: keyring-touch.has-hover ? #9b59b6.with-alpha(0.15) : transparent;

                    HorizontalLayout {
                        padding-left: 12px;
                        spacing: 10px;

                        Text {
                            text: "ðŸ”‘";
                            font-size: 15px;
                            vertical-alignment: center;
                        }

                        VerticalLayout {
                            alignment: center;
                            spacing: 1px;
                            Text {
                                text: "Fix GnuPG Keyring";
                                font-size: 13px;
                                font-weight: 500;
                                color: Palette.foreground;
                            }
                            Text {
                                text: "Reset & repopulate keys";
                                font-size: 11px;
                                color: Palette.foreground;
                                opacity: 0.5;
                            }
                        }
                    }

                    keyring-touch := TouchArea {
                        mouse-cursor: pointer;
                        clicked => {
                            show-troubleshoot-menu = false;
                            root.fix-keyring();
                        }
                    }
                }
            }
        }
    }

    // Local package install overlay
    if show-local-install: Rectangle {
        width: 100%;
        height: 100%;
        background: #000000.with-alpha(0.6);

        TouchArea {
            clicked => { root.cancel-local-install(); }
        }

        Rectangle {
            x: (parent.width - self.width) / 2;
            y: (parent.height - self.height) / 2;
            width: 480px;
            height: 320px;
            background: Palette.background;
            border-radius: 16px;
            drop-shadow-blur: 30px;
            drop-shadow-color: #000000.with-alpha(0.3);
            drop-shadow-offset-y: 8px;

            TouchArea {}

            VerticalLayout {
                padding: 28px;
                spacing: 20px;

                // Header
                HorizontalLayout {
                    spacing: 16px;

                    Rectangle {
                        width: 56px;
                        height: 56px;
                        border-radius: 12px;
                        background: #9b59b6;

                        Text {
                            text: "ðŸ“¦";
                            font-size: 26px;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }
                    }

                    VerticalLayout {
                        spacing: 4px;
                        alignment: center;

                        Text {
                            text: "Install Local Package";
                            font-size: 20px;
                            font-weight: 600;
                            color: Palette.foreground;
                        }

                        Text {
                            text: local-package.display-name != "" ? local-package.display-name : "Unknown Package";
                            font-size: 14px;
                            color: Palette.foreground;
                            opacity: 0.7;
                        }
                    }
                }

                Rectangle { height: 1px; background: Palette.border; }

                // Package info
                VerticalLayout {
                    spacing: 10px;

                    HorizontalLayout {
                        Text { text: "Version:"; width: 80px; font-size: 13px; color: Palette.foreground; opacity: 0.6; }
                        Text { text: local-package.version; font-size: 13px; color: Palette.foreground; }
                    }

                    HorizontalLayout {
                        Text { text: "Size:"; width: 80px; font-size: 13px; color: Palette.foreground; opacity: 0.6; }
                        Text { text: local-package.installed-size; font-size: 13px; color: Palette.foreground; }
                    }

                    HorizontalLayout {
                        Text { text: "File:"; width: 80px; font-size: 13px; color: Palette.foreground; opacity: 0.6; }
                        Text {
                            text: local-package-path;
                            font-size: 12px;
                            color: Palette.foreground;
                            opacity: 0.8;
                            overflow: elide;
                            horizontal-stretch: 1;
                        }
                    }
                }

                Rectangle { vertical-stretch: 1; }

                // Actions
                HorizontalLayout {
                    spacing: 12px;
                    alignment: end;

                    Button {
                        text: "Cancel";
                        clicked => { root.cancel-local-install(); }
                    }

                    Button {
                        text: "Install";
                        primary: true;
                        enabled: !busy;
                        clicked => { root.install-local-package(local-package-path); }
                    }
                }
            }
        }
    }

    // Confirmation popup overlay
    if show-confirm-popup: Rectangle {
        width: 100%;
        height: 100%;
        background: #000000.with-alpha(0.5);

        TouchArea {
            clicked => { root.cancel-confirm(); }
        }

        Rectangle {
            x: (parent.width - self.width) / 2;
            y: (parent.height - self.height) / 2;
            width: 440px;
            height: confirm-package-count > 1 ? 420px : 340px;
            background: Palette.background;
            border-radius: 16px;
            drop-shadow-blur: 30px;
            drop-shadow-color: #000000.with-alpha(0.3);
            drop-shadow-offset-y: 8px;

            TouchArea {}

            VerticalLayout {
                padding: 28px;
                spacing: 16px;

                // Header with icon
                HorizontalLayout {
                    spacing: 16px;

                    Rectangle {
                        width: 48px;
                        height: 48px;
                        border-radius: 12px;
                        background: confirm-action == "remove" || confirm-action == "bulk-remove" ? #e74c3c : #9b59b6;

                        Text {
                            text: confirm-action == "remove" || confirm-action == "bulk-remove" ? "ðŸ—‘" : (confirm-action == "update" || confirm-action == "update-all" ? "â¬†" : "ðŸ“¦");
                            font-size: 22px;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }
                    }

                    VerticalLayout {
                        spacing: 4px;
                        alignment: center;

                        Text {
                            text: confirm-title;
                            font-size: 18px;
                            font-weight: 600;
                            color: Palette.foreground;
                        }

                        if confirm-package-count > 1: Text {
                            text: confirm-package-count + " packages";
                            font-size: 13px;
                            color: Palette.foreground;
                            opacity: 0.6;
                        }
                    }
                }

                Rectangle { height: 1px; background: Palette.border; }

                // Package details (single package)
                if confirm-package-count <= 1: VerticalLayout {
                    spacing: 8px;

                    HorizontalLayout {
                        Text { text: "Package:"; width: 70px; font-size: 13px; color: Palette.foreground; opacity: 0.6; }
                        Text { text: confirm-package-names; font-size: 13px; color: Palette.foreground; overflow: elide; horizontal-stretch: 1; }
                    }

                    if confirm-version != "": HorizontalLayout {
                        Text { text: "Version:"; width: 70px; font-size: 13px; color: Palette.foreground; opacity: 0.6; }
                        Text { text: confirm-version; font-size: 13px; color: Palette.foreground; }
                    }

                    if confirm-size != "": HorizontalLayout {
                        Text { text: "Size:"; width: 70px; font-size: 13px; color: Palette.foreground; opacity: 0.6; }
                        Text { text: confirm-size; font-size: 13px; color: Palette.foreground; }
                    }

                    if confirm-deps != "": HorizontalLayout {
                        Text { text: "Deps:"; width: 70px; font-size: 13px; color: Palette.foreground; opacity: 0.6; }
                        Text { text: confirm-deps; font-size: 13px; color: Palette.foreground; overflow: elide; horizontal-stretch: 1; }
                    }
                }

                // Package list (bulk)
                if confirm-package-count > 1: Rectangle {
                    vertical-stretch: 1;
                    background: Palette.alternate-background.with-alpha(0.5);
                    border-radius: 6px;

                    ScrollView {
                        VerticalLayout {
                            padding: 10px;
                            Text {
                                text: confirm-package-names;
                                font-size: 12px;
                                font-family: "monospace";
                                color: Palette.foreground;
                                wrap: word-wrap;
                            }
                        }
                    }
                }

                if confirm-package-count <= 1: Rectangle { vertical-stretch: 1; }

                // Action buttons
                HorizontalLayout {
                    spacing: 12px;
                    alignment: end;

                    Rectangle {
                        width: 80px;
                        height: 34px;
                        border-radius: 6px;
                        background: cancel-confirm-touch.has-hover ? Palette.control-background : Palette.alternate-background;

                        Text {
                            text: "Cancel";
                            font-size: 13px;
                            color: Palette.foreground;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }

                        cancel-confirm-touch := TouchArea {
                            mouse-cursor: pointer;
                            clicked => { root.cancel-confirm(); }
                        }
                    }

                    Rectangle {
                        width: 100px;
                        height: 34px;
                        border-radius: 6px;
                        background: confirm-action == "remove" || confirm-action == "bulk-remove" ? #e74c3c : #9b59b6;

                        Text {
                            text: confirm-action == "remove" || confirm-action == "bulk-remove" ? "Remove" :
                                  confirm-action == "update" || confirm-action == "update-all" ? "Update" : "Install";
                            font-size: 13px;
                            font-weight: 600;
                            color: white;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }

                        TouchArea {
                            mouse-cursor: pointer;
                            clicked => { root.confirm-operation(); }
                        }
                    }
                }
            }
        }
    }

    // Progress popup overlay
    if show-progress-popup: Rectangle {
        width: 100%;
        height: 100%;
        background: #000000.with-alpha(0.5);

        TouchArea {}

        Rectangle {
            x: (parent.width - self.width) / 2;
            y: (parent.height - self.height) / 2;
            width: min(560px, parent.width - 40px);
            height: min(460px, parent.height - 40px);
            background: Palette.background;
            border-radius: 16px;
            clip: true;
            drop-shadow-blur: 30px;
            drop-shadow-color: #000000.with-alpha(0.3);
            drop-shadow-offset-y: 8px;

            VerticalLayout {
                spacing: 0;

                // Title bar with X close button
                Rectangle {
                    height: 44px;
                    background: Palette.alternate-background.with-alpha(0.5);

                    HorizontalLayout {
                        padding-left: 20px;
                        padding-right: 10px;

                        Text {
                            text: progress-popup-title;
                            font-size: 15px;
                            font-weight: 600;
                            color: Palette.foreground;
                            vertical-alignment: center;
                            horizontal-stretch: 1;
                        }

                        // Done indicator
                        if progress-popup-done: Text {
                            text: progress-popup-success ? "âœ“" : "âœ—";
                            font-size: 16px;
                            font-weight: 700;
                            color: progress-popup-success ? #2ecc71 : #e74c3c;
                            vertical-alignment: center;
                        }

                        // X close button â€” always visible
                        Rectangle {
                            width: 30px;
                            height: 30px;
                            border-radius: 6px;
                            background: prog-close-x.has-hover ? Palette.foreground.with-alpha(0.1) : transparent;

                            Text {
                                text: "âœ•";
                                font-size: 14px;
                                color: Palette.foreground;
                                opacity: 0.6;
                                horizontal-alignment: center;
                                vertical-alignment: center;
                            }

                            prog-close-x := TouchArea {
                                mouse-cursor: pointer;
                                clicked => { root.close-progress-popup(); }
                            }
                        }
                    }
                }

                Rectangle { height: 1px; background: Palette.border; opacity: 0.3; }

                // Progress bar with percentage
                if !progress-popup-done: Rectangle {
                    height: 36px;

                    // Bar track
                    Rectangle {
                        x: 20px;
                        y: (parent.height - 14px) / 2;
                        width: parent.width - 80px;
                        height: 14px;
                        border-radius: 7px;
                        background: Palette.border;

                        // Bar fill
                        Rectangle {
                            width: progress-popup-percent > 0 ? parent.width * (progress-popup-percent / 100) : 0;
                            height: 100%;
                            border-radius: 7px;
                            background: #9b59b6;
                            animate width { duration: 300ms; easing: ease-in-out; }
                        }
                    }

                    // Percentage text
                    Text {
                        x: parent.width - 56px;
                        y: 0;
                        width: 44px;
                        height: parent.height;
                        text: progress-popup-percent + "%";
                        font-size: 13px;
                        font-weight: 700;
                        color: #9b59b6;
                        horizontal-alignment: right;
                        vertical-alignment: center;
                    }
                }

                // Done bar (replaces progress bar)
                if progress-popup-done: Rectangle {
                    height: 36px;

                    Rectangle {
                        x: 20px;
                        y: (parent.height - 14px) / 2;
                        width: parent.width - 80px;
                        height: 14px;
                        border-radius: 7px;
                        background: progress-popup-success ? #2ecc71 : #e74c3c;
                    }

                    Text {
                        x: parent.width - 56px;
                        y: 0;
                        width: 44px;
                        height: parent.height;
                        text: "100%";
                        font-size: 13px;
                        font-weight: 700;
                        color: progress-popup-success ? #2ecc71 : #e74c3c;
                        horizontal-alignment: right;
                        vertical-alignment: center;
                    }
                }

                // Stage text
                if !progress-popup-done: Rectangle {
                    height: 24px;

                    HorizontalLayout {
                        padding-left: 20px;
                        padding-right: 20px;

                        Text {
                            text: "â–¸ " + progress-popup-stage;
                            font-size: 11px;
                            color: Palette.foreground;
                            opacity: 0.6;
                            overflow: elide;
                            vertical-alignment: center;
                        }
                    }
                }

                // Done status text
                if progress-popup-done: Rectangle {
                    height: 24px;

                    HorizontalLayout {
                        padding-left: 20px;

                        Text {
                            text: progress-popup-success ? "â–¸ Operation completed successfully" : "â–¸ Operation failed â€” check output above";
                            font-size: 11px;
                            font-weight: 500;
                            color: progress-popup-success ? #2ecc71 : #e74c3c;
                            vertical-alignment: center;
                        }
                    }
                }

                Rectangle { height: 1px; background: Palette.border; opacity: 0.2; }

                // Live output area
                Rectangle {
                    vertical-stretch: 1;
                    background: Palette.background.with-alpha(0.6);

                    ScrollView {
                        viewport-y: min(0px, self.visible-height - self.viewport-height);

                        VerticalLayout {
                            padding: 12px;

                            Text {
                                text: progress-popup-output;
                                font-size: 11px;
                                font-family: "monospace";
                                color: Palette.foreground;
                                opacity: 0.8;
                                wrap: word-wrap;
                            }
                        }
                    }
                }

                // User input area â€” always visible when operation is running
                if !progress-popup-done: Rectangle {
                    height: progress-popup-show-input ? 64px : 40px;
                    background: progress-popup-show-input ? #e67e22.with-alpha(0.08) : Palette.alternate-background.with-alpha(0.5);
                    animate height { duration: 150ms; }
                    animate background { duration: 150ms; }

                    Rectangle { y: 0; width: 100%; height: 1px; background: progress-popup-show-input ? #e67e22.with-alpha(0.3) : Palette.border; opacity: 0.5; }

                    VerticalLayout {
                        padding: 6px;
                        padding-left: 16px;
                        padding-right: 16px;
                        spacing: 4px;

                        // Prompt text (only when pacman asks something)
                        if progress-popup-show-input: Text {
                            text: "âš  " + progress-popup-prompt;
                            font-size: 11px;
                            font-weight: 500;
                            color: #e67e22;
                            overflow: elide;
                        }

                        HorizontalLayout {
                            spacing: 8px;

                            Text {
                                text: "â¯";
                                font-size: 12px;
                                color: #9b59b6;
                                vertical-alignment: center;
                            }

                            progress-input := LineEdit {
                                horizontal-stretch: 1;
                                placeholder-text: progress-popup-show-input ? "Type response and press Enter..." : "Send input to process...";
                                accepted(text) => {
                                    root.progress-popup-send-input(text);
                                    self.text = "";
                                }
                            }
                        }
                    }
                }
            }
        }
    }

    // Terminal popup overlay
    if show-terminal: Rectangle {
        width: 100%;
        height: 100%;
        background: #000000.with-alpha(0.5);

        TouchArea {}

        Rectangle {
            x: (parent.width - self.width) / 2;
            y: (parent.height - self.height) / 2;
            width: min(700px, parent.width - 40px);
            height: min(500px, parent.height - 40px);
            border-radius: 12px;
            clip: true;
            background: Palette.background.with-alpha(0.85);
            drop-shadow-blur: 50px;
            drop-shadow-color: #000000.with-alpha(0.35);
            drop-shadow-offset-y: 8px;

            VerticalLayout {
                // Title bar
                Rectangle {
                    height: 40px;
                    background: Palette.alternate-background.with-alpha(0.9);

                    HorizontalLayout {
                        padding-left: 14px;
                        padding-right: 10px;

                        Text {
                            text: terminal-title;
                            font-size: 13px;
                            font-weight: 500;
                            color: Palette.foreground;
                            vertical-alignment: center;
                            horizontal-stretch: 1;
                            overflow: elide;
                        }

                        // Close button (always visible â€” kills process if still running)
                        Rectangle {
                            width: 28px;
                            height: 28px;
                            border-radius: 6px;
                            background: close-touch.has-hover ? Palette.foreground.with-alpha(0.1) : transparent;

                            Text {
                                text: "âœ•";
                                font-size: 14px;
                                color: Palette.foreground;
                                opacity: 0.6;
                                horizontal-alignment: center;
                                vertical-alignment: center;
                            }

                            close-touch := TouchArea {
                                mouse-cursor: pointer;
                                clicked => { root.terminal-close(); }
                            }
                        }
                    }
                }

                Rectangle { height: 1px; background: Palette.border; opacity: 0.5; }

                // Terminal output area â€” semi-transparent
                Rectangle {
                    vertical-stretch: 1;
                    background: Palette.background.with-alpha(0.6);

                    ScrollView {
                        // Auto-scroll to bottom as new output arrives
                        viewport-y: min(0px, self.visible-height - self.viewport-height);
                        VerticalLayout {
                            padding: 10px;
                            Text {
                                text: terminal-output;
                                font-size: 13px;
                                font-family: "monospace";
                                color: Palette.foreground;
                                wrap: word-wrap;
                            }
                        }
                    }
                }

                // Input area (hidden when done)
                if !terminal-done: Rectangle {
                    height: 36px;
                    background: Palette.alternate-background.with-alpha(0.9);

                    Rectangle { y: 0; width: 100%; height: 1px; background: Palette.border; opacity: 0.5; }

                    HorizontalLayout {
                        padding-left: 12px;
                        padding-right: 12px;
                        spacing: 8px;

                        Text {
                            text: "â¯";
                            font-size: 13px;
                            color: #9b59b6;
                            vertical-alignment: center;
                        }

                        term-input := LineEdit {
                            horizontal-stretch: 1;
                            placeholder-text: "Type response and press Enter...";
                            accepted(text) => {
                                root.terminal-send-input(text);
                                self.text = "";
                            }
                        }
                    }
                }

                // Done status bar
                if terminal-done: Rectangle {
                    height: 30px;
                    background: terminal-success ? #2ecc71.with-alpha(0.12) : #e74c3c.with-alpha(0.12);

                    HorizontalLayout {
                        padding-left: 14px;

                        Text {
                            text: terminal-success ? "âœ“ Completed successfully" : "âœ— Operation failed";
                            font-size: 12px;
                            font-weight: 500;
                            color: terminal-success ? #2ecc71 : #e74c3c;
                            vertical-alignment: center;
                        }
                    }
                }
            }
        }
    }

}
