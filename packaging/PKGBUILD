# Maintainer: Your Name <your.email@example.com>
pkgname=xpackagemanager
pkgver=0.1.4
pkgrel=1
pkgdesc="A modern package manager for Arch Linux supporting pacman and Flatpak"
arch=('x86_64')
url="https://github.com/example/xpackagemanager"
license=('GPL-3.0-or-later')
depends=(
    'pacman'
    'flatpak'
    'polkit'
    'fontconfig'
    'freetype2'
    'qt6-base'
)
makedepends=(
    'rust'
    'cargo'
    'qt6-base'
)
provides=('xpackagemanager')
conflicts=('xpackagemanager-git')
source=()
sha256sums=()

# Project root is one directory up from packaging/
_projectdir="$startdir/.."

build() {
    cd "$_projectdir"

    # Use Qt6 for native system theme integration
    export QMAKE=qmake6

    # Strip -flto flags from C/CXX flags â€” LTO breaks the cpp crate's
    # struct metadata extraction used by qttypes (Slint Qt backend)
    export CFLAGS="${CFLAGS//-flto=auto/}"
    export CXXFLAGS="${CXXFLAGS//-flto=auto/}"
    export CFLAGS="${CFLAGS//-flto/}"
    export CXXFLAGS="${CXXFLAGS//-flto/}"

    # Build optimized release binary
    cargo build --release --bin xpackagemanager
}

package() {
    cd "$_projectdir"

    # Install binary
    install -Dm755 "target/release/xpackagemanager" "$pkgdir/usr/bin/xpackagemanager"

    # Install desktop file
    install -Dm644 "packaging/xpackagemanager.desktop" "$pkgdir/usr/share/applications/xpackagemanager.desktop"

    # Install MIME type for .pkg.tar.zst files
    install -Dm644 "packaging/x-alpm-package.xml" "$pkgdir/usr/share/mime/packages/x-alpm-package.xml"

    # Install polkit policy
    install -Dm644 "packaging/org.xpackagemanager.policy" "$pkgdir/usr/share/polkit-1/actions/org.xpackagemanager.policy"

    # Clean up build artifacts
    cargo clean
}

post_install() {
    # Update MIME database
    update-mime-database /usr/share/mime &>/dev/null || true
    # Update desktop database
    update-desktop-database -q || true
}

post_upgrade() {
    post_install
}

post_remove() {
    post_install
}
